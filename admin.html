<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weighbridge Admin - Command Center</title>
    <style>
        :root {
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --primary: #3b82f6;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --border: #334155;
        }

        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg-dark); color: var(--text-main); margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; }

        /* --- LOGIN SCREEN --- */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 23, 42, 0.95); z-index: 999;
            display: flex; align-items: center; justify-content: center;
        }
        .login-box {
            background: var(--bg-card); padding: 40px; border-radius: 12px;
            width: 350px; text-align: center; border: 1px solid var(--border);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
        }
        .login-box input {
            width: 100%; padding: 12px; margin: 20px 0; background: var(--bg-dark);
            border: 1px solid var(--border); color: white; border-radius: 6px;
        }
        .btn-login { background: var(--primary); width: 100%; padding: 12px; border: none; color: white; border-radius: 6px; font-weight: bold; cursor: pointer; }
        .btn-login:hover { background: #2563eb; }

        /* --- DASHBOARD LAYOUT --- */
        #dashboard { display: none; height: 100%; display: flex; flex-direction: column; }
        
        /* Header */
        header {
            background: var(--bg-card); border-bottom: 1px solid var(--border);
            padding: 0 30px; height: 70px; display: flex; align-items: center; justify-content: space-between;
        }
        .brand { font-size: 1.25rem; font-weight: bold; color: var(--primary); display: flex; align-items: center; gap: 10px; }
        .logout-btn { background: transparent; border: 1px solid var(--danger); color: var(--danger); padding: 8px 16px; border-radius: 6px; cursor: pointer; transition: 0.2s; }
        .logout-btn:hover { background: var(--danger); color: white; }

        /* Main Content */
        .main-content { flex: 1; padding: 30px; overflow-y: auto; max-width: 1600px; margin: 0 auto; width: 100%; box-sizing: border-box; }

        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--bg-card); padding: 20px; border-radius: 8px; border: 1px solid var(--border); }
        .stat-label { color: var(--text-muted); font-size: 0.85rem; font-weight: 600; text-transform: uppercase; }
        .stat-val { font-size: 2rem; font-weight: 800; margin-top: 5px; }
        .st-blue { color: var(--primary); }
        .st-orange { color: var(--warning); }
        .st-green { color: var(--success); }

        /* Controls Area */
        .controls-bar { display: flex; justify-content: space-between; margin-bottom: 15px; }
        .search-inp { background: var(--bg-card); border: 1px solid var(--border); padding: 10px; color: white; border-radius: 6px; width: 300px; }

        /* Table */
        .table-container { background: var(--bg-card); border-radius: 8px; border: 1px solid var(--border); overflow: hidden; }
        table { width: 100%; border-collapse: collapse; }
        th { background: rgba(0,0,0,0.2); text-align: left; padding: 15px; color: var(--text-muted); font-size: 0.85rem; text-transform: uppercase; border-bottom: 1px solid var(--border); }
        td { padding: 15px; border-bottom: 1px solid var(--border); vertical-align: middle; }
        tr:last-child td { border-bottom: none; }
        tr:hover { background: rgba(255,255,255,0.02); }

        /* Badges & Buttons */
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; }
        .bg-gate { background: rgba(239, 68, 68, 0.2); color: #fca5a5; }
        .bg-auth { background: rgba(59, 130, 246, 0.2); color: #93c5fd; }
        .bg-scale { background: rgba(245, 158, 11, 0.2); color: #fcd34d; }
        .bg-exit { background: rgba(16, 185, 129, 0.2); color: #6ee7b7; border: 1px solid #10b981; }

        .btn-action { padding: 8px 16px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 0.85rem; display: flex; align-items: center; gap: 6px; transition: 0.2s; }
        .btn-permit { background: var(--success); color: #064e3b; }
        .btn-permit:hover { background: #34d399; }
        .btn-exit-auth { background: var(--warning); color: #451a03; }
        .btn-exit-auth:hover { background: #fbbf24; }
        
        .sys-tools { margin-top: 40px; padding-top: 20px; border-top: 1px solid var(--border); }
        .btn-danger { background: transparent; border: 1px solid var(--danger); color: var(--danger); padding: 10px 20px; border-radius: 6px; cursor: pointer; }
        .btn-danger:hover { background: var(--danger); color: white; }

        /* Animation */
        @keyframes pulse-border { 0% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(245, 158, 11, 0); } 100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0); } }
        .urgent { animation: pulse-border 2s infinite; border-radius: 4px; }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-box">
            <h2>üõ°Ô∏è Admin Access</h2>
            <p style="color:var(--text-muted)">Weighbridge Control System</p>
            <input type="password" id="password-input" placeholder="Enter Password">
            <button class="btn-login" onclick="attemptLogin()">Access Dashboard</button>
            <p id="login-error" style="color:var(--danger); display:none; margin-top:10px;">Access Denied</p>
        </div>
    </div>

    <div id="dashboard" style="display:none;">
        <header>
            <div class="brand">
                <span>üöõ</span> SRISPL Admin
            </div>
            <div>
                <span id="conn-status" style="font-size:0.8rem; color:var(--text-muted); margin-right:15px;">‚óè Connecting...</span>
                <button class="logout-btn" onclick="location.reload()">Logout</button>
            </div>
        </header>

        <div class="main-content">
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Waiting at Gate</div>
                    <div class="stat-val st-orange" id="count-gate">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Inside Factory</div>
                    <div class="stat-val st-blue" id="count-inside">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Waiting for Exit</div>
                    <div class="stat-val st-green" id="count-exit">0</div>
                </div>
            </div>

            <div class="controls-bar">
                <h2 style="margin:0;">Active Operations</h2>
                <input type="text" class="search-inp" id="search-bar" placeholder="üîç Search Vehicle or ID..." onkeyup="renderList()">
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th width="80">ID</th>
                            <th>Vehicle No</th>
                            <th>Party</th>
                            <th>Type</th>
                            <th>Arrival Time</th>
                            <th>Current Status</th>
                            <th width="200">Required Action</th>
                        </tr>
                    </thead>
                    <tbody id="list-body">
                        </tbody>
                </table>
                <div id="empty-msg" style="text-align:center; padding:40px; color:var(--text-muted); display:none;">
                    No active vehicles found.
                </div>
            </div>

            <div class="sys-tools">
                <h3 style="color:var(--text-muted);">‚ö†Ô∏è System Tools</h3>
                <div style="display:flex; gap:15px;">
                    <button class="btn-danger" onclick="adminAction('RESET_SERIAL_NUMBER')">‚Üª Reset Daily Serial Number</button>
                </div>
                <p style="font-size:0.8rem; color:var(--text-muted); margin-top:10px;">
                    Note: Resetting Serial Number will clear the Pending List. Only use at start of day.
                </p>
            </div>

        </div>
    </div>

    <script>
    const WS_PROTOCOL = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
const WS_URL = `${WS_PROTOCOL}//${window.location.host}`;
        const ADMIN_PASS = "admin123"; // Simple client check
        const SECRET_KEY = "@nkit@nurag"; // For server actions

        let ws;
        let pendingList = [];

        function attemptLogin() {
            const input = document.getElementById('password-input').value;
            if (input === ADMIN_PASS) {
                document.getElementById('login-overlay').style.display = 'none';
                document.getElementById('dashboard').style.display = 'flex';
                connect();
            } else {
                document.getElementById('login-error').style.display = 'block';
            }
        }

        function connect() {
            ws = new WebSocket(WS_URL);
            ws.onopen = () => {
                document.getElementById('conn-status').innerHTML = '<span style="color:var(--success)">‚óè System Online</span>';
            };
            ws.onmessage = (event) => {
                const msg = JSON.parse(event.data);
                if (msg.type === 'PENDING_LIST_UPDATE') {
                    pendingList = msg.payload;
                    updateStats();
                    renderList();
                } else if (msg.type === 'cj_ALERT') {
                    showNotification("New Vehicle at Gate", msg.message);
                } else if (msg.type === 'ADMIN_ACTION_RESULT') {
                    alert(msg.payload.message);
                }
            };
            ws.onclose = () => {
                document.getElementById('conn-status').innerHTML = '<span style="color:var(--danger)">‚óè Offline</span>';
                setTimeout(connect, 3000);
            };
        }

        function updateStats() {
            const atGate = pendingList.filter(r => r.status === 'AT_GATE').length;
            const exitWait = pendingList.filter(r => r.status === 'FIRST_Wt_DONE').length;
            const inside = pendingList.length - atGate; // Roughly everyone not at gate is inside

            document.getElementById('count-gate').innerText = atGate;
            document.getElementById('count-inside').innerText = inside;
            document.getElementById('count-exit').innerText = exitWait;
        }

        function renderList() {
            const tbody = document.getElementById('list-body');
            const query = document.getElementById('search-bar').value.toLowerCase();
            
            tbody.innerHTML = '';
            
            const filtered = pendingList.filter(r => 
                r.vehicleNumber.toLowerCase().includes(query) || 
                r.id.toString().includes(query) ||
                r.partyName.toLowerCase().includes(query)
            );

            if(filtered.length === 0) {
                document.getElementById('empty-msg').style.display = 'block';
                return;
            }
            document.getElementById('empty-msg').style.display = 'none';

            filtered.forEach(r => {
                let statusBadge = '';
                let actionBtn = '<span style="color:var(--text-muted); font-size:0.85rem;">Monitoring...</span>';
                let time = new Date(r.createdTimestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

                // Logic for Buttons & Badges
                if(r.status === 'AT_GATE') {
                    statusBadge = '<span class="badge bg-gate">AT GATE</span>';
                    actionBtn = `<button class="btn-action btn-permit urgent" onclick="authorizeEntry(${r.id})">‚úÖ Permit Entry</button>`;
                } 
                else if (r.status === 'AUTHORIZED') {
                    statusBadge = '<span class="badge bg-auth">ENTRY PERMITTED</span>';
                }
                else if (r.status === 'ON_SCALE') {
                    statusBadge = '<span class="badge bg-scale">WEIGHING (1st)</span>';
                }
                else if (r.status === 'FIRST_Wt_DONE') {
                    statusBadge = '<span class="badge bg-scale">INSIDE (Loaded)</span>';
                    // ** CRITICAL: EXIT BUTTON **
                    actionBtn = `<button class="btn-action btn-exit-auth urgent" onclick="authorizeExit(${r.id})">‚ö†Ô∏è Permit Exit</button>`;
                }
                else if (r.status === 'EXIT_AUTHORIZED') {
                    statusBadge = '<span class="badge bg-exit">EXIT PERMITTED</span>';
                    actionBtn = '<span style="color:var(--success); font-weight:bold;">‚úî Cleared</span>';
                }

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><strong>#${r.id}</strong></td>
                    <td><span style="font-size:1.1rem; color:white;">${r.vehicleNumber}</span></td>
                    <td>${r.partyName}</td>
                    <td>${r.transactionType}</td>
                    <td>${time}</td>
                    <td>${statusBadge}</td>
                    <td>${actionBtn}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- ACTIONS ---
        function authorizeEntry(id) {
            if(confirm("Allow this vehicle to enter?")) {
                ws.send(JSON.stringify({ type: 'AUTHORIZE_ENTRY', payload: { id } }));
            }
        }

        function authorizeExit(id) {
            if(confirm("Allow this vehicle to exit (2nd Weight)?")) {
                ws.send(JSON.stringify({ type: 'AUTHORIZE_EXIT', payload: { id } }));
            }
        }

        function adminAction(actionType) {
            if(confirm("Are you sure? This affects the database.")) {
                // Send the hardcoded server secret for security (defined in server.js)
                ws.send(JSON.stringify({ 
                    type: 'ADMIN_ACTION', 
                    payload: { password: SECRET_KEY, action: actionType } 
                }));
            }
        }

        // --- NOTIFICATIONS ---
        function showNotification(title, body) {
            // Audio
            new Audio('https://assets.mixkit.co/sfx/preview/mixkit-software-interface-start-2574.mp3').play().catch(e=>{});
            // Desktop
            if(Notification.permission === "granted") new Notification(title, { body });
            else if(Notification.permission !== "denied") Notification.requestPermission();
        }

    </script>
</body>
</html>